"use strict";function rmdir(e,n,o){(null===n||"undefined"==typeof n)&&(n=function(e){}),fs.readdir(e,function(t,i){return t?n(t):void!function a(t){if(t)return n(t);var r=i.shift();if(null===r||"undefined"==typeof r)return void(o?fs.rmdir(e,n):n());var s=e+"/"+r;fs.lstat(s,function(e,o){return e?n(e):void(o.isDirectory()?rmdir(s,a,!0):fs.unlink(s,a))})}()})}function recurlist(e,n,o,t){if(e){var i=[],a;fs.readdir(e,function(r,s){if(r)return console.log(r);var l=s.length;return l?void s.forEach(function(r){r=e+"/"+r.replace(regslashes,"/"),fs.stat(r,function(e,s){s&&s.isDirectory()?t?recurlist(r,n,function(e){i=i.concat(e),--l||o(i)},t):--l||o(i.sort(sorter)):(a=r.match(regext),a&&-1!==n.indexOf(a[1].toLowerCase())&&i.push(r),--l||o(i.sort(sorter)))})}):o(i.sort(sorter))})}}function unpack(e,n){var o=e.split(".");o=o[o.length-1].toLowerCase();var t=e.split(".");if(t=t[t.length-1].toLowerCase(),"win32"==os)t="rar"===o||"cbr"===o?'"'+path+'dist/exec/win/UnRAR.exe" x '+e+" *."+imgtypes.join(" *.")+" "+path+"/temp -y -r":'"'+path+'dist/exec/win/7za.exe" e '+e+" *."+imgtypes.join(" *.")+" -o"+path+"/temp -y -r";else{if(t.indexOf("r")>-1)return t="chmod 755 "+safepath+"dist/exec/mac/unar/unar",void exec(t,function(o,i,a){return a?(error("Unsupported or corrupted file."),console.log(a)):o?(error("Unsupported or corrupted file."),console.log(o)):(t=safepath+'dist/exec/mac/unar/unar "'+e+'" *.'+imgtypes.join(" *.")+" -o "+safepath+"/temp",void exec(t,function(e,o,t){return t?(error("Unsupported or corrupted file."),console.log(t)):e?(error("Unsupported or corrupted file."),console.log(e)):void recurlist("temp",imgtypes,n,1)}))});t='unzip "'+e+'" -d '+safepath+"/temp"}exec(t,function(e,o,t){return t&&console.log(t),e?(error("Unsupported or corrupted file."),console.log(e)):void recurlist("temp",imgtypes,n,1)})}function sorter(e,n){var o=e.toLowerCase(),t=n.toLowerCase();return t>o?-1:o>t?1:0}function error(e){}function showCursor(){1>=cursorHideTime&&document.body.classList.remove("hideCursor"),cursorHideTime=cursorHideDelay}function mainLoop(e){cursorHideTime>1?cursorHideTime--:1===cursorHideTime&&(cursorHideTime=0,document.body.classList.add("hideCursor")),keys[39]===!0?pageCont.scrollLeft+=scrollSpeed:keys[37]===!0&&(pageCont.scrollLeft-=scrollSpeed),keys[40]===!0?pageCont.scrollTop+=scrollSpeed:keys[38]===!0&&(pageCont.scrollTop-=scrollSpeed),requestAnimationFrame(mainLoop)}function clearBookmarks(){bookmarks.length=0,localStorage.bookmarks=JSON.stringify(bookmarks),buildRecent()}function addBookmark(e,n){for(var o=!1,t=bookmarks.length;t--;)if(bookmarks[t][0]==e){var i=bookmarks.splice(t,1)[0];bookmarks.push(i),o=!0;break}return o===!1?("number"!=typeof n&&(n=0),bookmarks.push([e,n]),pruneBookmarks(),buildRecent(),localStorage.bookmarks=JSON.stringify(bookmarks)):("number"==typeof n?(bookmarks[bookmarks.length-1][1]=n,localStorage.bookmarks=JSON.stringify(bookmarks)):n=bookmarks[bookmarks.length-1][1],buildRecent()),n}function updateBookmark(){bookmarks[bookmarks.length-1][1]=file.curPage,localStorage.bookmarks=JSON.stringify(bookmarks)}function pruneBookmarks(){for(;bookmarks.total>pruneLength;)bookmarks.shift()}function buildRecent(){for(var e=new gui.Menu,n,o=bookmarks.length,t=10;t--&&(o--,-1!==o);)e.append(new gui.MenuItem({label:bookmarks[o][0],click:recentClick(bookmarks[o][0])}));e.append(new gui.MenuItem({type:"separator"})),e.append(new gui.MenuItem({label:"Clear items",click:clearBookmarks,enabled:bookmarks.length?!0:!1})),openRecent.submenu=e}function recentClick(e){return function(){load(e)}}function checkUpdates(){var e=require("http"),n=require("fs");n.readFile("package.json","utf8",function(o,t){var i=JSON.parse(t).version,a=i.split("-"),r=new XMLHttpRequest,s="http://www.smartergames.com/bin/comicbookviewier/"+a[0]+"/";r.onreadystatechange=function(){if(4==r.readyState&&200==r.status){var o=JSON.parse(r.responseText);if(o.version===i)return alert("Your version of Smarter Comic Book Viewer is up to date!");if(o.link)gui.Shell.openExternal(o.link),gui.App.quit();else if(o.installer){-1===o.installer.indexOf("http")&&(o.installer=s+o.installer);var t=e.get(o.installer,function(e){var t="";e.setEncoding("binary");var i=0,a=e.headers["content-length"];e.on("data",function(e){i+=e.length,console.log(Math.round(i/a*100)),t+=e}),e.on("end",function(){console.log("File saved.");var e=o.installer.split(regslashes).pop();n.writeFile(path+"temp/"+e,t,"binary",function(n){n?(console.log(n),alert("Something went wrong downloading the latest version. Please try again later!")):(gui.Shell.openItem(path+"temp/"+e),gui.App.quit())})})})}}},r.open("GET",s+"package.json",!0),r.send()})}function loadPrevNext(e){var n=file.loc.split("/");n.pop(),n=n.join("/"),console.log("searching dir "+n),recurlist(n,filetypes,function(n){for(var o=0;o<n.length;o++)n[o]=n[o].replace(regslashes,"/"),file.loc==n[o]&&(dirFilesOn=o);dirFiles=n,1===e?(dirFilesOn++,dirFilesOn<dirFiles.length&&load(dirFiles[dirFilesOn])):(dirFilesOn--,dirFilesOn>=0&&load(dirFiles[dirFilesOn]))})}function closeFile(){bottomUI.classList.remove("fadeOut"),topUI.classList.remove("fadeOut"),document.body.classList.remove("fileOpen"),document.title="Smarter Comic Book Viewer",page.canvas.width=0,page.canvas.height=0}function load(e,n){document.getElementById("waitMsg").style.display="none",loader.style.display="block",closeFile(),rmdir("temp",function(){unpack(e,function(o){function t(){i++,i===o.length&&("number"!=typeof n&&(n=addBookmark(e)),file.loc=e,file.pages=a,file.curPage=-1,file.curPage=n,file.pageTotal=o.length)}e=e.replace(regslashes,"/");for(var i=0,a=[],r=0;r<o.length;r++){a[r]=new Image;for(var s=o[r].split("/"),l=s.length;l--;)s[l]=encodeURIComponent(s[l]);a[r].src="../"+s.join("/"),a[r].onload=t}})})}function wakeBottomUI(){bottomUI.classList.remove("fadeOut"),setTimeout(wakeBottomUITime,25)}function wakeBottomUITime(){bottomUI.classList.add("fadeOut")}function wakeTopUI(){topUI.classList.remove("fadeOut"),setTimeout(wakeTopUITime,25)}function wakeTopUITime(){topUI.classList.add("fadeOut")}function nextPage(){file.curPage<file.pageTotal-1&&file.curPage++}function prevPage(){file.curPage>0&&file.curPage--}function zoomIn(){zoomMod+=10,page.canvas.style.maxWidth=zoomMod+"%",page.canvas.width<window.innerWidth&&(page.canvas.style.width=page.canvas.width*(zoomMod/100)+"px")}function zoomOut(){zoomMod-=10,page.canvas.style.maxWidth=zoomMod+"%",page.canvas.width<window.innerWidth&&(page.canvas.style.width=page.canvas.width*(zoomMod/100)+"px")}function loadPage(e){100!==zoomMod&&(zoomMod=100,page.canvas.style.maxWidth="100%",page.canvas.style.width="auto"),page.canvas.height=file.pages[file.curPage].height,page.canvas.width=file.pages[file.curPage].width,page.drawImage(file.pages[file.curPage],0,0),pageNum.innerText=file.curPage+1,wakeBottomUI(),e?pageCont.scrollTop=page.canvas.height:pageCont.scrollTop=0}var fs=require("fs"),exec=require("child_process").exec,os=require("os").platform(),regspace=/ /g,regext=/\.([0-9a-z]+$)/i,regslashes=/[\\\/]/g,filetypes=["zip","rar","cbz","cbr","cb7","7z","cbt","tar","cba","ace"],imgtypes=["jpg","jpeg","gif","png","bmp","svg","tif"],path=process.execPath.replace(regslashes,"/").replace(/[^\/]*$/,""),safepath;"win32"===os?safepath=path.replace(regspace,"\\ "):(path=path.split("/"),path.pop(),path.pop(),path.pop(),path.pop(),path.pop(),path=path.join("/")+"/Resources/app.nw/",safepath=path.replace(regspace,"\\ "));var zoomMod=100,gui=require("nw.gui"),win=gui.Window.get();window.ondragover=function(e){return e.preventDefault(),!1},window.ondrop=function(e){return e.preventDefault(),e.dataTransfer.files.length&&load(e.dataTransfer.files[0].path),!1},window.addEventListener("dblclick",function(e){e.clientX/window.innerWidth<.5?file.curPage>0&&file.curPage--:file.curPage<file.pageTotal-1&&file.curPage++});var mouseCoords={x:0,y:0,lastX:0,lastY:0,screenX:0,screenY:0},mouseDown=!1,cursorHideDelay=80,cursorHideTime=cursorHideDelay;window.addEventListener("mousedown",function(e){return file.loc?(document.body.classList.add("grabbing"),mouseCoords.x=e.clientX,mouseCoords.y=e.clientY,mouseCoords.screenX=pageCont.scrollLeft,mouseCoords.screenY=pageCont.scrollTop,mouseDown=!0,void showCursor()):void open.click()}),window.addEventListener("mousemove",function(e){mouseDown===!0&&(pageCont.scrollTop=mouseCoords.screenY+(mouseCoords.y-e.clientY),pageCont.scrollLeft=mouseCoords.screenX+(mouseCoords.x-e.clientX)),(mouseCoords.lastY!==e.screenY||mouseCoords.lastX!==e.screenX)&&(mouseCoords.lastY=e.screenY,mouseCoords.lastX=e.screenX,showCursor())}),window.addEventListener("mouseup",function(e){document.body.classList.remove("grabbing"),mouseDown=!1,showCursor()});var scrollSpeed=15,lastTime=0,delta;requestAnimationFrame(mainLoop);var open=document.getElementById("open");open.accept="."+filetypes.join(",."),open.addEventListener("change",function(e){load(this.value)});var keys={};document.body.addEventListener("keydown",function(e){var n=!1;if(!keys[e.keyCode]){switch(e.keyCode){case 33:prevPage();break;case 34:nextPage();break;case 219:loadPrevNext();break;case 221:loadPrevNext(1);break;case 188:prevPage();break;case 190:nextPage();break;case 73:wakeTopUI(),wakeBottomUI();break;case 36:file.curPage=0;break;case 35:file.curPage=file.pageTotal-1;break;case 37:e.preventDefault();break;case 38:e.preventDefault();break;case 39:e.preventDefault();break;case 40:e.preventDefault();break;case 187:case 107:zoomIn();break;case 189:case 109:zoomOut();break;default:n=!0}if(n===!1)return keys[e.keyCode]=!0,e.preventDefault(),!1}}),document.addEventListener("keyup",function(e){keys[e.keyCode]=!1});var pruneLength=30,bookmarks=localStorage.bookmarks;bookmarks?bookmarks=JSON.parse(bookmarks):(bookmarks=[],localStorage.bookmarks=JSON.stringify(bookmarks));var mb=new gui.Menu({type:"menubar"}),item;mb.createMacBuiltin("Smarter Comic Book Viewer"),mb.removeAt(1),mb.removeAt(1),item=new gui.MenuItem({type:"normal",label:"File"},1),item.submenu=new gui.Menu,item.submenu.append(new gui.MenuItem({label:"Open...",key:"o",click:function(){open.click()}})),item.submenu.append(new gui.MenuItem({label:"Open most recent",key:"r",click:function(){var e=bookmarks.length;e&&load(bookmarks[e-1][0])}}));var openRecent=new gui.MenuItem({label:"Open Recent"});item.submenu.append(openRecent),buildRecent(),item.submenu.append(new gui.MenuItem({label:"Opening Containing Folder",click:function(){console.log(file.loc),gui.Shell.showItemInFolder(file.loc)}})),item.submenu.append(new gui.MenuItem({type:"separator"})),item.submenu.append(new gui.MenuItem({label:"Previous File",key:"[",modifiers:"",click:loadPrevNext})),item.submenu.append(new gui.MenuItem({label:"Next File",key:"]",modifiers:"",click:function(){loadPrevNext(1)}})),item.submenu.append(new gui.MenuItem({type:"separator"})),item.submenu.append(new gui.MenuItem({label:"Close File",key:"w",click:function(){file.loc="",file.pages=[],file.curPage=-1,file.pageTotal=0,bottomUI.classList.remove("fadeOut"),topUI.classList.remove("fadeOut")}})),mb.append(item),item=new gui.MenuItem({type:"normal",label:"Page"},1),item.submenu=new gui.Menu,item.submenu.append(new gui.MenuItem({label:"Previous Page",key:",",modifiers:"",click:prevPage})),item.submenu.append(new gui.MenuItem({label:"Next Page",key:".",modifiers:"",click:nextPage})),item.submenu.append(new gui.MenuItem({type:"separator"})),item.submenu.append(new gui.MenuItem({label:"First Page",click:function(){file.curPage=0}})),item.submenu.append(new gui.MenuItem({label:"Last Page",click:function(){file.curPage=file.pageTotal-1}})),item.submenu.append(new gui.MenuItem({type:"separator"})),item.submenu.append(new gui.MenuItem({label:"Zoom In",key:"+",modifiers:"",click:function(){zoomMod+=10,page.canvas.style.maxWidth=zoomMod+"%"}})),item.submenu.append(new gui.MenuItem({label:"Zoom Out",key:"-",modifiers:"",click:function(){zoomMod-=10,page.canvas.style.maxWidth=zoomMod+"%"}})),item.submenu.append(new gui.MenuItem({type:"separator"})),item.submenu.append(new gui.MenuItem({label:"Info",key:"i",modifiers:"",click:function(){wakeTopUI(),wakeBottomUI()}})),mb.append(item),item=new gui.MenuItem({type:"normal",label:"Window"},1),item.submenu=new gui.Menu,item.submenu.append(new gui.MenuItem({label:"Minimize",key:"m",click:function(){win.minimize()}})),item.submenu.append(new gui.MenuItem({label:"Fullscreen",key:"f",click:function(){win.toggleFullscreen()}})),mb.append(item),item=new gui.MenuItem({type:"normal",label:"Help"},1),item.submenu=new gui.Menu,item.submenu.append(new gui.MenuItem({label:"Check for Updates...",click:checkUpdates})),item.submenu.append(new gui.MenuItem({label:"Reload",click:function(){win.reload()}})),item.submenu.append(new gui.MenuItem({label:"Debug Console",key:"d",click:function(){win.showDevTools()}})),mb.append(item),win.menu=mb;var screenW=gui.Screen.Init().screens[0].bounds,screenH=screenW.height-50;screenW=screenW.width-50;var winState=localStorage.winState;if(winState){winState=JSON.parse(winState);var winClip=!1;winState.x+winState.w>screenW&&(winState.x=screenW/2-winState.w/2,winState.x+winState.w>screenW&&(winClip=!0)),winState.y+winState.h>screenH&&(winState.y=screenH/2-winState.h/2,winState.y+winState.h>screenH&&(winClip=!0)),winClip===!1&&(win.x=winState.x,win.y=winState.y,win.width=winState.w,win.height=winState.h),winState.max&&win.toggleFullscreen()}else winState={x:win.x,y:win.y,w:win.width,h:win.height,max:0,dev:0};win.y<0&&(win.y=50,win.height+125>screenH&&(win.height=screenH-75)),win.x<0&&(win.x=50,win.width+125>screenW&&(win.width=screenW-75));var resizeTimeout;setTimeout(function(){win.on("move",function(){winState.x=win.x,winState.y=win.y}),win.on("devtools-opened",function(){winState.dev=1}),win.on("devtools-closed",function(){winState.dev=0}),window.addEventListener("resize",function(){clearTimeout(resizeTimeout),resizeTimeout=setTimeout(function(){return win.isFullscreen?void(winState.max=1):(winState.max=0,winState.w=win.width,void(winState.h=win.height))})})},1e3);var file={loc:"",pages:[],curPage:0,pageTotal:0},active=0,regfilename=/([^\/]+)(?=\.\w+$)/;Object.observe(file,function(e){for(var n=0;n<e.length;n++)if("update"===e[n].type)if("loc"===e[n].name){if(file.loc){document.body.classList.add("fileOpen");var o=file.loc.match(regfilename)[0].trim();fileTitle.innerText=o,document.title=o,wakeTopUI(),addBookmark(file.loc,file.curPage),pageTotal.innerText=file.pageTotal,loadPage()}else closeFile();loader.style.display="none"}else"curPage"===e[n].name&&-1!==file.curPage&&(updateBookmark(),"number"==typeof e[n].oldValue&&e[n].oldValue>file.curPage?loadPage(!0):loadPage())});var page=document.getElementById("page").getContext("2d"),pageCont=document.getElementById("pageCont"),pageNum=document.getElementById("pageNum"),pageTotal=document.getElementById("pageTotal"),fileTitle=document.getElementById("fileTitle"),dirFiles=[],dirFilesOn=0,loader=document.getElementById("loader"),bottomUI=document.getElementById("bottomUI"),topUI=document.getElementById("topUI"),isClosing=!1;win.on("close",function(){isClosing!==!0&&localStorage&&(isClosing=!0,win.hide(),localStorage.winState=JSON.stringify(winState),gui.App.clearCache(),win.close(!0))}),gui.App.argv.length?load(gui.App.argv[0]):bookmarks.length,gui.App.on("open",function(e){load(e)}),winState.dev&&win.showDevTools(),win.on("loaded",function(){setTimeout(function(){win.show()},25)});
//# sourceMappingURL=./script.js.map